name: Sync Project Keywords to Repo Labels

on:
  push:
    branches:
      - main
    paths:
      - 'pyproject.toml'
  workflow_dispatch:

jobs:
  sync_labels:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install TOML parser
        run: pip install toml

      - name: Extract & Format Keywords from pyproject.toml
        id: extract_keywords
        run: |
          python -c "
          import toml
          import json

          COLOR_MAP = {
              'ioc': '006090',
              'di': '006090',
              'python': '3776AB',
              'async': 'E34848',
              'minimalistic': 'BFD4F2'
          }

          with open('pyproject.toml', 'r') as f:
              data = toml.load(f)
          
          keywords = data.get('project', {}).get('keywords', [])
          
          formatted_labels = []
          for keyword in keywords:
              color = COLOR_MAP.get(keyword.lower(), 'B6B6B6') 
              description = f'Automatically synced from pyproject.toml keyword: {keyword}'
              
              formatted_labels.append({
                  'name': keyword,
                  'color': color,
                  'description': description
              })
          
          print(f'labels_json={json.dumps(formatted_labels)}')
          " >> $GITHUB_OUTPUT

      - name: Sync Labels to Repository (Official Action)
        uses: actions/label-sync@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          labels: ${{ steps.extract_keywords.outputs.labels_json }}
